<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Welcome, {{ current_user.name }}!</h1>
        <div class="tabs">
            <button class="tablink" onclick="openTab(event, 'CharacterCreation')" id="defaultOpen">Character Creation</button>
            <button class="tablink" onclick="openTab(event, 'Admin')">Admin</button>
        </div>

        <div id="CharacterCreation" class="tabcontent">
            <h3>Character Creation Steps (D&D 5e)</h3>
            <ul>
                <!-- Steps will be populated by Flask -->
                {% for step in character_creation_steps %}
                <li>{{ step }}</li>
                {% endfor %}
            </ul>
        </div>

        <div id="Admin" class="tabcontent">
            <h3>Admin Page</h3>
            <p>Enter a REST endpoint URL to retrieve and display its structure.</p>
            <input type="text" id="restUrl" placeholder="Enter REST API URL">
            <button onclick="fetchStructure()">Get structure</button>
            <div id="treeView">
                <!-- Tree view will be populated here -->
            </div>
        </div>

        <a href="{{ url_for('logout') }}">Logout</a>
    </div>

    <script>
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablink");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        // Get the element with id="defaultOpen" and click on it
        document.getElementById("defaultOpen").click();

        async function fetchStructure() {
            const url = document.getElementById('restUrl').value;
            const treeView = document.getElementById('treeView');
            treeView.innerHTML = 'Loading...';

            if (!url) {
                treeView.innerHTML = 'Please enter a URL.';
                return;
            }

            try {
                // We'll use a new Flask endpoint to handle the backend fetching and processing
                const response = await fetch(`/admin/get_structure?url=${encodeURIComponent(url)}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                // Clear previous tree
                treeView.innerHTML = '';

                // Create and append the tree
                const ul = createTree(data, true); // Pass true for root level
                treeView.appendChild(ul);

            } catch (error) {
                treeView.innerHTML = `Error: ${error.message}`;
                console.error('Error fetching structure:', error);
            }
        }

        function createTree(data, isRoot = false) {
            const ul = document.createElement('ul');
            if (isRoot) {
                ul.className = 'tree-root';
            }

            for (const key in data) {
                const li = document.createElement('li');

                const keySpan = document.createElement('strong');
                keySpan.textContent = `${key}: `;
                li.appendChild(keySpan);

                const value = data[key];

                if (typeof value === 'object' && value !== null) {
                    if (Array.isArray(value)) {
                        // Special handling for 'results' array or any array of objects
                        if (value.every(item => typeof item === 'object' && item !== null && !Array.isArray(item))) {
                            const itemSummary = document.createElement('span');
                            itemSummary.className = 'array-summary';
                            itemSummary.textContent = `[Array of ${value.length} objects] `;
                            li.appendChild(itemSummary);

                            const expandButton = document.createElement('button');
                            expandButton.textContent = 'Expand';
                            expandButton.className = 'expand-btn';
                            li.appendChild(expandButton);

                            const subUl = document.createElement('ul');
                            subUl.className = 'collapsible-content';
                            subUl.style.display = 'none'; // Initially collapsed

                            value.forEach((item, index) => {
                                const itemLi = document.createElement('li');
                                const itemKeySpan = document.createElement('strong');
                                // Try to find a 'name' or 'id' for a more descriptive summary, otherwise use index
                                let itemTitle = item.name || item.id || `Item ${index + 1}`;
                                itemKeySpan.textContent = `${itemTitle}: `;
                                itemLi.appendChild(itemKeySpan);

                                const itemExpandButton = document.createElement('button');
                                itemExpandButton.textContent = 'Details';
                                itemExpandButton.className = 'expand-btn';
                                itemLi.appendChild(itemExpandButton);

                                const itemSubUl = createTree(item);
                                itemSubUl.className = 'collapsible-content';
                                itemSubUl.style.display = 'none';
                                itemLi.appendChild(itemSubUl);

                                itemExpandButton.onclick = () => {
                                    const isHidden = itemSubUl.style.display === 'none';
                                    itemSubUl.style.display = isHidden ? 'block' : 'none';
                                    itemExpandButton.textContent = isHidden ? 'Collapse' : 'Details';
                                };
                                subUl.appendChild(itemLi);
                            });
                            li.appendChild(subUl);

                            expandButton.onclick = () => {
                                const isHidden = subUl.style.display === 'none';
                                subUl.style.display = isHidden ? 'block' : 'none';
                                expandButton.textContent = isHidden ? 'Collapse' : 'Expand';
                            };

                        } else { // Array of simple types or mixed
                            const valueSpan = document.createElement('span');
                            valueSpan.textContent = `[Array (${value.length} items)]`;
                            li.appendChild(valueSpan);
                            // Optionally, could still expand simple arrays if needed
                            const subUl = createTree(value); // Recursive call for arrays
                            li.appendChild(subUl);
                        }
                    } else { // It's an object
                        const subUl = createTree(value);
                        li.appendChild(subUl);
                    }
                } else { // Simple value (string, number, boolean)
                    const valueSpan = document.createElement('span');
                    valueSpan.textContent = value;
                    li.appendChild(valueSpan);
                }
                ul.appendChild(li);
            }
            return ul;
        }
    </script>
</body>
</html>
