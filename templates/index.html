<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .message.debug {
            background-color: #f0f0f0;
            color: #333;
            border-left: 3px solid #ccc;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 0.8em;
        }
        .message.recap {
            background-color: #eef;
            border-left: 3px solid #aac;
            font-style: italic;
        }
        .message.debug pre {
            white-space: pre-wrap;
            overflow-wrap: break-word;
        }
    </style>
</head>
<body>
    <div id="hamburger">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </div>
    <div id="menu" style="left: -200px;">
        <a href="/logout">Logout</a>
        <a href="{{ url_for('new_character') }}">New Character</a>
        <hr>
        {% for character in characters %}
            <div class="character-item">
                <a href="#" onclick="selectCharacter(event, {{ character.id }})">{{ character.character_name }}</a>
                <button class="delete-btn" onclick="deleteCharacter(event, {{ character.id }})">X</button>
            </div>
        {% endfor %}
        <hr>
        {% if current_user.email == admin_email %}
            <a href="/admin">Admin</a>
        {% endif %}
    </div>
    <div id="character-sheet-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
    </div>
    <div id="history-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
    </div>
    <div id="character-sheet-overlay">
        <div id="character-sheet">
            <div id="close-character-sheet">X</div>
            <div id="character-sheet-history-container">
                <label for="character-sheet-history-select">History:</label>
                <select id="character-sheet-history-select"></select>
            </div>
            <hr>
            <div id="character-sheet-content">
                <!-- Character sheet content goes here -->
            </div>
        </div>
    </div>
    <div id="history-overlay">
        <div id="history-popup">
            <div id="close-history">X</div>
            <h2>Message History</h2>
            <div id="history-messages"></div>
        </div>
    </div>
    <div id="app">
        <div id="chat-window">
            <div id="messages"></div>
            <div id="thinking-indicator" style="display: none;">Thinking...</div>
            <div id="input-area">
                <input id="message-input" autocomplete="off" disabled /><button id="send-button" disabled>Send</button>
                <input type="hidden" id="active-character-id" value="">
            </div>
        </div>
        <div id="description-pane"></div>
    </div>
    <script>
        var socket = io.connect('https://' + document.domain + ':' + location.port);

        socket.on('connect', function() {
            console.log('Connected to the server');
        });

        socket.on('message', function(data) {
            var characterId = document.getElementById('active-character-id').value;
            if (data.character_id && data.character_id.toString() !== characterId) {
                return;
            }
            console.log('Received message: ' + data.text);
            document.getElementById('thinking-indicator').style.display = 'none';
            addMessage(data.text, data.sender);
        });

        socket.on('debug_message', function(data) {
            var characterId = document.getElementById('active-character-id').value;
            if (data.character_id && data.character_id.toString() !== characterId) {
                return;
            }
            console.log('Received debug message');
            addMessage('--- DEBUG: ' + data.type + ' ---\n' + data.data, 'debug');
        });

        socket.on('clear_chat', function(data) {
            var characterId = document.getElementById('active-character-id').value;
            if (data.character_id && data.character_id.toString() === characterId) {
                document.getElementById('messages').innerHTML = '';
            }
        });

        socket.on('disconnect', function() {
            console.log('Disconnected from the server');
        });

        document.getElementById('send-button').onclick = function() {
            var input = document.getElementById('message-input');
            var message = input.value;
            var characterId = document.getElementById('active-character-id').value;
            if (message.trim() !== '' && characterId) {
                addMessage(message, 'sent');
                socket.emit('message', { 'message': message, 'character_id': characterId });
                input.value = '';
                document.getElementById('thinking-indicator').style.display = 'block';
            }
        };

        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('send-button').click();
            }
        });

        function addMessage(text, type) {
            var messages = document.getElementById('messages');
            var messageElement = document.createElement('div');
            messageElement.classList.add('message', type);
            if (type === 'debug') {
                messageElement.innerHTML = '<pre>' + text + '</pre>';
            } else {
                messageElement.innerHTML = text;
            }
            messages.appendChild(messageElement);
            messages.scrollTop = messages.scrollHeight;

            if (type === 'sent') {
                var choiceContainers = document.querySelectorAll('.choice-container');
                choiceContainers.forEach(function(container) {
                    var buttons = container.querySelectorAll('button');
                    buttons.forEach(function(button) {
                        button.disabled = true;
                    });
                });
            }
        }

        let draggedItem = null;

        function drag(ev) {
            draggedItem = ev.target;
            setTimeout(() => {
                ev.target.style.display = 'none';
            }, 0);
        }

        document.addEventListener('dragover', function(event) {
            event.preventDefault();
        });

        document.addEventListener('dragenter', function(event) {
            if (event.target.classList.contains('value-card')) {
                event.target.classList.add('drop-target');
            }
        });

        document.addEventListener('dragleave', function(event) {
            if (event.target.classList.contains('value-card')) {
                event.target.classList.remove('drop-target');
            }
        });

        document.addEventListener('drop', function(event) {
            event.preventDefault();
            if (event.target.classList.contains('value-card')) {
                const temp = event.target.innerHTML;
                event.target.innerHTML = draggedItem.innerHTML;
                draggedItem.innerHTML = temp;
                event.target.classList.remove('drop-target');
            }
            draggedItem.style.display = 'flex';
            draggedItem = null;
        });

        function confirmOrderedList() {
            var characterId = document.getElementById('active-character-id').value;
            if (characterId) {
                const listItems = document.querySelectorAll('#sortable-list .sortable-item');
                const orderedList = [];
                listItems.forEach(item => {
                    const name = item.dataset.name;
                    const value = item.querySelector('.value-card .value').innerText;
                    orderedList.push({ name, value });
                });

                let messageText = "I have assigned the scores as follows:\n";
                orderedList.forEach(item => {
                    messageText += `${item.name}: ${item.value}\n`;
                });
                addMessage(messageText, 'sent');

                socket.emit('user_ordered_list', { 'ordered_list': orderedList, 'character_id': characterId });
                document.getElementById('thinking-indicator').style.display = 'block';

                // Disable the list
                const container = document.querySelector('.ordered-list-container');
                container.querySelectorAll('button').forEach(button => button.disabled = true);
                container.querySelectorAll('.value-card').forEach(value => value.setAttribute('draggable', 'false'));
            }
        }

        function moveValueUp(element) {
            const listItem = element.closest('.sortable-item');
            const previousListItem = listItem.previousElementSibling;
            if (previousListItem) {
                const currentValueCard = listItem.querySelector('.value-card');
                const previousValueCard = previousListItem.querySelector('.value-card');
                const temp = currentValueCard.innerHTML;
                currentValueCard.innerHTML = previousValueCard.innerHTML;
                previousValueCard.innerHTML = temp;
            }
        }

        function moveValueDown(element) {
            const listItem = element.closest('.sortable-item');
            const nextListItem = listItem.nextElementSibling;
            if (nextListItem) {
                const currentValueCard = listItem.querySelector('.value-card');
                const nextValueCard = nextListItem.querySelector('.value-card');
                const temp = currentValueCard.innerHTML;
                currentValueCard.innerHTML = nextValueCard.innerHTML;
                nextValueCard.innerHTML = temp;
            }
        }

        function sendChoice(choice) {
            var characterId = document.getElementById('active-character-id').value;
            if (characterId) {
                addMessage('You chose: ' + choice, 'sent');
                socket.emit('user_choice', { 'choice': choice, 'character_id': characterId });
                document.getElementById('thinking-indicator').style.display = 'block';

                var choiceContainers = document.querySelectorAll('.choice-container');
                choiceContainers.forEach(function(container) {
                    var buttons = container.querySelectorAll('button');
                    buttons.forEach(function(button) {
                        button.disabled = true;
                    });
                });
            }
        }

        function confirmMultiSelect(button) {
            var characterId = document.getElementById('active-character-id').value;
            if (characterId) {
                const container = button.closest('.multiselect-container');
                const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
                const choices = [];
                checkboxes.forEach(checkbox => {
                    choices.push(checkbox.value);
                });

                let messageText = "You chose the following: " + choices.join(', ');
                addMessage(messageText, 'sent');

                socket.emit('user_multi_choice', { 'choices': choices, 'character_id': characterId });
                document.getElementById('thinking-indicator').style.display = 'block';

                // Disable the multiselect
                container.querySelectorAll('input[type="checkbox"]').forEach(checkbox => checkbox.disabled = true);
                button.disabled = true;
            }
        }

        document.addEventListener('change', function(event) {
            if (event.target.matches('.multiselect-option input[type="checkbox"]')) {
                const container = event.target.closest('.multiselect-container');
                const maxChoices = parseInt(container.dataset.maxChoices, 10);
                const checkboxes = container.querySelectorAll('input[type="checkbox"]');
                const checkedCount = container.querySelectorAll('input[type="checkbox"]:checked').length;

                if (checkedCount >= maxChoices) {
                    checkboxes.forEach(checkbox => {
                        if (!checkbox.checked) {
                            checkbox.disabled = true;
                        }
                    });
                } else {
                    checkboxes.forEach(checkbox => {
                        checkbox.disabled = false;
                    });
                }
            }
        });

        document.addEventListener('mouseover', function(event) {
            const multiSelectTarget = event.target.closest('.multiselect-option');
            const singleChoiceTarget = event.target.closest('.singlechoice-option');

            if (multiSelectTarget || singleChoiceTarget) {
                const optionElement = multiSelectTarget || singleChoiceTarget;
                const description = optionElement.querySelector('.description').textContent;
                const descriptionPane = document.getElementById('description-pane');
                descriptionPane.textContent = description;
                descriptionPane.style.display = 'block';
            }
        });

        document.addEventListener('mouseout', function(event) {
            const multiSelectTarget = event.target.closest('.multiselect-option');
            const singleChoiceTarget = event.target.closest('.singlechoice-option');

            if (multiSelectTarget || singleChoiceTarget) {
                const descriptionPane = document.getElementById('description-pane');
                descriptionPane.style.display = 'none';
            }
        });

        function enableChat() {
            document.getElementById('message-input').disabled = false;
            document.getElementById('send-button').disabled = false;
        }

        function selectCharacter(event, characterId, isNewCharacter = false) {
            if (event) {
                event.stopPropagation();
            }
            document.getElementById('active-character-id').value = characterId;
            enableChat();
            document.getElementById('messages').innerHTML = '';
            socket.emit('initiate_chat', { 'character_id': characterId });
            document.getElementById('thinking-indicator').style.display = 'block';

            if (!isNewCharacter) {
                fetch('/recap/' + characterId)
                    .then(response => response.json())
                    .then(data => {
                        if (data.recap) {
                            addMessage(data.recap, 'recap');
                        }
                        document.getElementById('thinking-indicator').style.display = 'none';
                    })
                    .catch(error => {
                        console.error('Error fetching recap:', error);
                        document.getElementById('thinking-indicator').style.display = 'none';
                    });
            }
        }

        function deleteCharacter(event, characterId) {
            event.stopPropagation();
            if (confirm('Are you sure you want to delete this character?')) {
                fetch('/delete_character/' + characterId, {
                    method: 'DELETE',
                }).then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Failed to delete character.');
                    }
                });
            }
        }

        document.getElementById('hamburger').onclick = function() {
            var menu = document.getElementById('menu');
            if (menu.style.left === '-200px') {
                menu.style.left = '0';
            } else {
                menu.style.left = '-200px';
            }
        };

        socket.on('character_sheet_data', function(data) {
            var characterId = document.getElementById('active-character-id').value;
            if (data.character_id && data.character_id.toString() !== characterId) {
                return;
            }

            const sheetContentDiv = document.getElementById('character-sheet-content');
            sheetContentDiv.innerHTML = data.html_template;

            for (const key in data.sheet_data) {
                const element = sheetContentDiv.querySelector('#' + key);
                if (element) {
                    element.innerText = data.sheet_data[key];
                }
            }

            document.getElementById('character-sheet-overlay').style.display = 'block';
        });

        socket.on('character_sheet_error', function(data) {
            var characterId = document.getElementById('active-character-id').value;
            if (data.character_id && data.character_id.toString() === characterId) {
                alert('Error: ' + data.message);
            }
        });

        let characterSheetHistory = [];

        socket.on('character_sheet_history_data', function(data) {
            var characterId = document.getElementById('active-character-id').value;
            if (data.character_id && data.character_id.toString() !== characterId) {
                return;
            }

            characterSheetHistory = data.history;
            const historySelect = document.getElementById('character-sheet-history-select');
            historySelect.innerHTML = ''; // Clear previous options

            if (characterSheetHistory.length > 0) {
                characterSheetHistory.forEach((record, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.innerText = record.timestamp;
                    historySelect.appendChild(option);
                });
                historySelect.onchange = function() {
                    const selectedIndex = this.value;
                    const selectedRecord = characterSheetHistory[selectedIndex];
                    const sheetContentDiv = document.getElementById('character-sheet-content');

                    // The HTML template is already in the div, just need to re-populate it.
                    for (const key in selectedRecord.sheet_data) {
                        const element = sheetContentDiv.querySelector('#' + key);
                        if (element) {
                            element.innerText = selectedRecord.sheet_data[key];
                        }
                    }
                };
            }
        });

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const newCharId = urlParams.get('new_char_id');
            if (newCharId) {
                selectCharacter(null, newCharId, true);
            }
        };

        document.getElementById('character-sheet-button').onclick = function() {
            var characterId = document.getElementById('active-character-id').value;
            if (characterId) {
                socket.emit('get_character_sheet', { 'character_id': characterId });
                socket.emit('get_character_sheet_history', { 'character_id': characterId });
            } else {
                alert('Please select a character first.');
            }
        };

        document.getElementById('close-character-sheet').onclick = function() {
            document.getElementById('character-sheet-overlay').style.display = 'none';
        };

        document.getElementById('history-button').onclick = function() {
            var characterId = document.getElementById('active-character-id').value;
            if (characterId) {
                socket.emit('get_message_history', { 'character_id': characterId });
            } else {
                alert('Please select a character first.');
            }
        };

        document.getElementById('close-history').onclick = function() {
            document.getElementById('history-overlay').style.display = 'none';
        };

        socket.on('message_history_data', function(data) {
            var characterId = document.getElementById('active-character-id').value;
            if (data.character_id && data.character_id.toString() !== characterId) {
                return;
            }

            const historyMessagesDiv = document.getElementById('history-messages');
            historyMessagesDiv.innerHTML = ''; // Clear previous history

            data.history.forEach(function(msg) {
                var messageElement = document.createElement('div');
                var sender = msg.role === 'user' ? 'sent' : 'received';
                messageElement.classList.add('message', sender);
                messageElement.innerHTML = msg.content;
                historyMessagesDiv.appendChild(messageElement);
            });

            document.getElementById('history-overlay').style.display = 'block';
        });
    </script>
</body>
</html>
